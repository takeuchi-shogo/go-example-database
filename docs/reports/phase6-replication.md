# Phase 6: ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

## Raft ç”¨èªé›†

### å½¹å‰²ï¼ˆRoleï¼‰

| ç”¨èª | æ„å‘³ | å½¹å‰² |
|------|------|------|
| **Leader** | ãƒªãƒ¼ãƒ€ãƒ¼ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ›¸ãè¾¼ã¿ã‚’å—ã‘ä»˜ã‘ã€Follower ã«è¤‡è£½ã™ã‚‹ã€‚1ã‚¯ãƒ©ã‚¹ã‚¿ã«1äººã ã‘ |
| **Follower** | ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ | Leader ã‹ã‚‰ã®æŒ‡ç¤ºã«å¾“ã†ã€‚ãƒ­ã‚°ã‚’å—ã‘å–ã£ã¦ä¿å­˜ã™ã‚‹ |
| **Candidate** | å€™è£œè€… | Leader ã«ãªã‚ŠãŸã„ãƒãƒ¼ãƒ‰ã€‚é¸æŒ™ä¸­ã®ä¸€æ™‚çš„ãªçŠ¶æ…‹ |

```text
çŠ¶æ…‹é·ç§»:
  èµ·å‹• â†’ Follower â†’ (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ) â†’ Candidate â†’ (éåŠæ•°ç²å¾—) â†’ Leader
                                        â†“
                                   (è² ã‘ãŸ) â†’ Follower
```

### æ™‚é–“ã«é–¢ã™ã‚‹ç”¨èª

| ç”¨èª | æ„å‘³ | ä¾‹ |
|------|------|-----|
| **Termï¼ˆä»»æœŸï¼‰** | é¸æŒ™ã®ã€Œä¸–ä»£ç•ªå·ã€ã€‚æ–°ã—ã„é¸æŒ™ãŒå§‹ã¾ã‚‹ãŸã³ã« +1 ã•ã‚Œã‚‹ | Term=3 ã¯ã€Œ3å›ç›®ã®é¸æŒ™ã§é¸ã°ã‚ŒãŸ Leader ã®æ™‚ä»£ã€ |
| **Heartbeatï¼ˆãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼‰** | Leader ãŒå®šæœŸçš„ã«é€ã‚‹ã€Œç”Ÿãã¦ã‚‹ã‚ˆã€ä¿¡å· | 150ms ã”ã¨ã«é€ä¿¡ |
| **Election Timeoutï¼ˆé¸æŒ™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰** | ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆãŒæ¥ãªããªã£ã¦ã‹ã‚‰é¸æŒ™ã‚’å§‹ã‚ã‚‹ã¾ã§ã®æ™‚é–“ | 300ã€œ500msï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰ |

```text
Term ã®æµã‚Œ:

Term=1: Leader A ãŒæ”¯é…
  Leader A â”€â”€â™¥â”€â”€â™¥â”€â”€â™¥â”€â”€â–¶ Follower B, C

Term=2: Leader A ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã€B ãŒæ–° Leader ã«
  Leader A ğŸ’€
  Candidate B: ã€ŒTerm=2 ã§é¸æŒ™ï¼ã€
  Leader B â”€â”€â™¥â”€â”€â™¥â”€â”€â™¥â”€â”€â–¶ Follower C

Term=3: Leader B ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã€C ãŒæ–° Leader ã«
  ...
```

### ãƒ­ã‚°ã«é–¢ã™ã‚‹ç”¨èª

| ç”¨èª | æ„å‘³ | ä¾‹ |
|------|------|-----|
| **Log Entryï¼ˆãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªï¼‰** | 1ã¤ã®ã‚³ãƒãƒ³ãƒ‰è¨˜éŒ² | `{Index: 5, Term: 2, Data: "INSERT..."}` |
| **Indexï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰** | ãƒ­ã‚°ã®ä½ç½®ç•ªå·ï¼ˆ1ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰ | Index=5 ã¯ã€Œ5ç•ªç›®ã®ã‚¨ãƒ³ãƒˆãƒªã€ |
| **commitIndex** | ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®ä½ç½®ã€‚ã“ã“ã¾ã§ã¯ç¢ºå®š | commitIndex=3 ãªã‚‰ 1ã€œ3 ã¯ç¢ºå®š |
| **lastApplied** | DB ã«é©ç”¨æ¸ˆã¿ã®ä½ç½® | lastApplied=2 ãªã‚‰ 1ã€œ2 ã¯ DB ã«åæ˜ æ¸ˆã¿ |

```text
ãƒ­ã‚°ã®ä¾‹:
  Index:  [  1  ][  2  ][  3  ][  4  ][  5  ]
  Term:   [  1  ][  1  ][  2  ][  2  ][  2  ]
  Data:   [INS A][INS B][UPD A][DEL C][INS D]
                        â†‘
                   commitIndex=3ï¼ˆã“ã“ã¾ã§ç¢ºå®šï¼‰
                 â†‘
            lastApplied=2ï¼ˆã“ã“ã¾ã§ DB ã«åæ˜ æ¸ˆã¿ï¼‰
```

### RPC ã«é–¢ã™ã‚‹ç”¨èª

| ç”¨èª | æ„å‘³ | ã„ã¤ä½¿ã† |
|------|------|---------|
| **RequestVote** | æŠ•ç¥¨ä¾é ¼ | Candidate ãŒé¸æŒ™æ™‚ã«ä»–ãƒãƒ¼ãƒ‰ã«é€ã‚‹ |
| **AppendEntries** | ãƒ­ã‚°è¿½åŠ ä¾é ¼ | Leader ãŒ Follower ã«ãƒ­ã‚°ã‚’é€ã‚‹ |
| **Heartbeat** | ç©ºã® AppendEntries | Leader ãŒå®šæœŸçš„ã«ã€Œç”Ÿãã¦ã‚‹ã€ã¨ä¼ãˆã‚‹ |

```text
RequestVote ã®æµã‚Œ:
  Candidate â†’ ã€ŒTerm=3 ã§æŠ•ç¥¨ã—ã¦ï¼ã€ â†’ Follower
  Candidate â† ã€ŒOKã€æŠ•ç¥¨ã—ãŸã€        â† Follower

AppendEntries ã®æµã‚Œ:
  Leader â†’ ã€Œã“ã®ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¦ã€ â†’ Follower
  Leader â† ã€ŒOKã€ä¿å­˜ã—ãŸã€       â† Follower
```

### ãã®ä»–ã®ç”¨èª

| ç”¨èª | æ„å‘³ |
|------|------|
| **Quorumï¼ˆã‚¯ã‚©ãƒ¼ãƒ©ãƒ ï¼‰** | éåŠæ•°ã€‚3å°ãªã‚‰2å°ã€5å°ãªã‚‰3å° |
| **Split Brainï¼ˆã‚¹ãƒ—ãƒªãƒƒãƒˆãƒ–ãƒ¬ã‚¤ãƒ³ï¼‰** | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­ã§2äººã® Leader ãŒç™ºç”Ÿã™ã‚‹å•é¡Œ |
| **PrevLogIndex / PrevLogTerm** | ç›´å‰ã®ãƒ­ã‚°ã®ä½ç½®ã¨ Termã€‚æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã«ä½¿ã† |

---

## Raft ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ã¯

### ä¸€è¨€ã§è¨€ã†ã¨

**è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ãŒã€ŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã€ã‚’æŒã¤ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ä»•çµ„ã¿**

### ãªãœå¿…è¦ã‹ï¼Ÿ

```
å•é¡Œ: ã‚µãƒ¼ãƒãƒ¼ãŒ1å°ã ã¨...

  Client â”€â”€â–¶ Server â”€â”€â–¶ ğŸ’€ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ â†’ ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ï¼
```

```
è§£æ±º: ã‚µãƒ¼ãƒãƒ¼ã‚’è¤‡æ•°å°ã«ã™ã‚‹

  Client â”€â”€â–¶ Server 1 (Leader)
             â”œâ”€â”€â–¶ Server 2 (Follower) â† åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡è£½
             â””â”€â”€â–¶ Server 3 (Follower) â† åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡è£½

  Server 1 ãŒè½ã¡ã¦ã‚‚ â†’ Server 2 or 3 ãŒå¼•ãç¶™ã
```

### Raft ã®3ã¤ã®å½¹å‰²

| å½¹å‰² | èª¬æ˜ |
|------|------|
| **Leader** | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ›¸ãè¾¼ã¿ã‚’å—ã‘ä»˜ã‘ã€ä»–ã®ãƒãƒ¼ãƒ‰ã«è¤‡è£½ã™ã‚‹ |
| **Follower** | Leader ã‹ã‚‰ã®ãƒ­ã‚°ã‚’å—ã‘å–ã£ã¦é©ç”¨ã™ã‚‹ |
| **Candidate** | Leader ãŒã„ãªã„æ™‚ã€é¸æŒ™ã«ç«‹å€™è£œã™ã‚‹ |

### Raft ã®3ã¤ã®æ©Ÿèƒ½

#### 1. ãƒªãƒ¼ãƒ€ãƒ¼é¸æŒ™ï¼ˆLeader Electionï¼‰

**ãªãœãƒªãƒ¼ãƒ€ãƒ¼ãŒå¿…è¦ã‹ï¼Ÿ**

ãƒªãƒ¼ãƒ€ãƒ¼ãŒã„ãªã„ã¨ã€è¤‡æ•°ã®ãƒãƒ¼ãƒ‰ãŒåŒæ™‚ã«æ›¸ãè¾¼ã¿ã‚’å—ã‘ä»˜ã‘ã¦ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆãŒç™ºç”Ÿã™ã‚‹ã€‚

```
ãƒªãƒ¼ãƒ€ãƒ¼ãªã—ã®å•é¡Œ:
  Client A â†’ Node 1: INSERT id=1, name='Alice'
  Client B â†’ Node 2: INSERT id=1, name='Bob'
  â†’ ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆï¼ˆã©ã£ã¡ãŒæ­£ã—ã„ï¼Ÿï¼‰

ãƒªãƒ¼ãƒ€ãƒ¼ã‚ã‚Šã®è§£æ±º:
  Client A â”€â”
            â”œâ”€â”€â–¶ Leader â”€â”€â–¶ Follower 1, 2
  Client B â”€â”˜
  â†’ Leader ãŒé †åºã‚’æ±ºå®š â†’ å…¨ãƒãƒ¼ãƒ‰åŒã˜ãƒ‡ãƒ¼ã‚¿
```

**ãªãœã€ŒæŠ•ç¥¨ã€ã¨ã„ã†ä»•çµ„ã¿ï¼Ÿ**

æ°‘ä¸»ä¸»ç¾©ã®ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ã€‚éåŠæ•°ã®åŒæ„ãŒãªã„ã¨ãƒªãƒ¼ãƒ€ãƒ¼ã«ãªã‚Œãªã„ãŸã‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­æ™‚ã‚‚ã€Œ2äººã®ãƒªãƒ¼ãƒ€ãƒ¼ã€ãŒç™ºç”Ÿã—ãªã„ã€‚

```
Leader ãŒè½ã¡ãŸï¼
     â†“
Follower ãŸã¡ãŒã€Œèª°ãŒæ¬¡ã® Leaderï¼Ÿã€ã‚’æŠ•ç¥¨ã§æ±ºã‚ã‚‹
     â†“
éåŠæ•°ã®ç¥¨ã‚’å¾—ãŸãƒãƒ¼ãƒ‰ãŒæ–° Leader ã«
```

#### 2. ãƒ­ã‚°è¤‡è£½ï¼ˆLog Replicationï¼‰

```
Client: INSERT INTO users VALUES (1, 'Alice')
     â†“
Leader: WAL ã«æ›¸ã â†’ Follower ã«é€ä¿¡
     â†“
Follower 1: å—ä¿¡ â†’ ã€ŒOKã€ã‚’è¿”ã™
Follower 2: å—ä¿¡ â†’ ã€ŒOKã€ã‚’è¿”ã™
     â†“
Leader: éåŠæ•°ã‹ã‚‰ OK â†’ ã‚³ãƒŸãƒƒãƒˆç¢ºå®š â†’ Client ã«æˆåŠŸã‚’è¿”ã™
```

#### 3. å®‰å…¨æ€§ï¼ˆSafetyï¼‰

- **éåŠæ•°ï¼ˆQuorumï¼‰** ãŒåŒæ„ã—ãªã„ã¨ã‚³ãƒŸãƒƒãƒˆã—ãªã„
- 3å°ãªã‚‰2å°ã€5å°ãªã‚‰3å°ã®åŒæ„ãŒå¿…è¦
- ã“ã‚Œã«ã‚ˆã‚Šã€Œ2ã¤ã® Leader ãŒåŒæ™‚ã«å­˜åœ¨ã™ã‚‹ã€å•é¡Œã‚’é˜²ã

### TiDB/CockroachDB ã§ã®ä½¿ã‚ã‚Œæ–¹

```
TiDB ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                TiDB Server              â”‚  â† SQL å‡¦ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               TiKV Cluster              â”‚  â† ãƒ‡ãƒ¼ã‚¿æ ¼ç´
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Region 1â”‚ â”‚ Region 2â”‚ â”‚ Region 3â”‚   â”‚
â”‚  â”‚  Raft   â”‚ â”‚  Raft   â”‚ â”‚  Raft   â”‚   â”‚  â† å„ Region ãŒ Raft ã§è¤‡è£½
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã¾ã¨ã‚

| é …ç›® | èª¬æ˜ |
|------|------|
| **ç›®çš„** | è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã€éšœå®³ã«å¼·ãã™ã‚‹ |
| **ä»•çµ„ã¿** | ãƒªãƒ¼ãƒ€ãƒ¼é¸æŒ™ + ãƒ­ã‚°è¤‡è£½ + éåŠæ•°åŒæ„ |
| **çµæœ** | 1å°è½ã¡ã¦ã‚‚ã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶šã€ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ãªã— |

---

## å®Ÿè£…è¨ˆç”»

### æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node 1    â”‚     â”‚   Node 2    â”‚     â”‚   Node 3    â”‚
â”‚  (Leader)   â”‚â”€â”€â”€â”€â–¶â”‚ (Follower)  â”‚â”€â”€â”€â”€â–¶â”‚ (Follower)  â”‚
â”‚             â”‚     â”‚             â”‚     â”‚             â”‚
â”‚  WAL Log    â”‚     â”‚  WAL Log    â”‚     â”‚  WAL Log    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

| Step | å†…å®¹ | ãƒ•ã‚¡ã‚¤ãƒ« |
|------|------|----------|
| 1 | ãƒãƒ¼ãƒ‰çŠ¶æ…‹ï¼ˆLeader/Follower/Candidateï¼‰ | `internal/raft/state.go` |
| 2 | Raft ãƒ­ã‚°ç®¡ç† | `internal/raft/log.go` |
| 3 | ãƒªãƒ¼ãƒ€ãƒ¼é¸æŒ™ | `internal/raft/election.go` |
| 4 | ãƒ­ã‚°è¤‡è£½ | `internal/raft/replication.go` |
| 5 | ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ | `internal/raft/heartbeat.go` |
| 6 | ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç† | `internal/replication/manager.go` |

### ã‚´ãƒ¼ãƒ«

**3ãƒãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚¿ã§1å°è½ã¡ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œãªã„**

---

## å®Ÿè£…å†…å®¹

### Step 1: ãƒãƒ¼ãƒ‰çŠ¶æ…‹ï¼ˆstate.goï¼‰âœ“

Raft ãƒãƒ¼ãƒ‰ã®3ã¤ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã€‚

```go
type NodeState int

const (
    Follower NodeState = iota
    Candidate
    Leader
)

type RaftNode struct {
    currentTerm uint64    // ç¾åœ¨ã®ä»»æœŸ
    votedFor    string    // æŠ•ç¥¨ã—ãŸãƒãƒ¼ãƒ‰ID
    state       NodeState // ç¾åœ¨ã®çŠ¶æ…‹
    nodeID      string    // ãƒãƒ¼ãƒ‰ID
    leaderID    string    // ãƒªãƒ¼ãƒ€ãƒ¼ID
}
```

çŠ¶æ…‹é·ç§»ãƒ¡ã‚½ãƒƒãƒ‰:
- `BecomeFollower()` - Follower ã«é·ç§»
- `BecomeCandidate()` - Candidate ã«é·ç§»
- `BecomeLeader()` - Leader ã«é·ç§»

---

### Step 2: Raft ãƒ­ã‚°ç®¡ç†ï¼ˆlog.goï¼‰âœ“

Raft ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã®ç®¡ç†ã‚’è¡Œã†ã€‚

```go
type LogEntry struct {
    Index uint64 // ãƒ­ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    Term  uint64 // ä»»æœŸ
    Data  []byte // ã‚³ãƒãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿
}

type RaftLog struct {
    entries     []LogEntry // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª
    commitIndex uint64     // ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    lastApplied uint64     // é©ç”¨æ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
}
```

#### å„é–¢æ•°ã®å½¹å‰²

| é–¢æ•° | ã„ã¤ä½¿ã† | èª°ãŒä½¿ã† |
|------|----------|----------|
| `Append` | ã‚³ãƒãƒ³ãƒ‰å—ä¿¡æ™‚ | Leader |
| `GetEntry/From` | ãƒ­ã‚°è¤‡è£½æ™‚ | Leader |
| `LastIndex/Term` | ãƒªãƒ¼ãƒ€ãƒ¼é¸æŒ™æ™‚ | Candidate/Follower |
| `SetCommitIndex` | éåŠæ•°è¤‡è£½å®Œäº†æ™‚ | Leader |
| `GetCommittedEntries` | DBé©ç”¨æ™‚ | å…¨ãƒãƒ¼ãƒ‰ |
| `MarkApplied` | DBé©ç”¨å®Œäº†æ™‚ | å…¨ãƒãƒ¼ãƒ‰ |
| `Truncate` | ãƒ­ã‚°ç«¶åˆè§£æ±ºæ™‚ | Follower |

#### è©³ç´°èª¬æ˜

**1. Append - ã‚³ãƒãƒ³ãƒ‰è¿½åŠ **
```
Client: INSERT INTO users VALUES (1, 'Alice')
    â†“
Leader: Append({Term: 3, Data: "INSERT..."})
    â†“
Leader: Follower ã«è¤‡è£½ã‚’é€ä¿¡
```

**2. GetEntriesFrom - ãƒ­ã‚°è¤‡è£½**
```
Leader: ã€ŒFollower ã® lastIndex ã¯ 5 ã ãªã€
    â†“
Leader: GetEntriesFrom(6) ã§å·®åˆ†å–å¾—
    â†“
Leader: Follower ã«é€ä¿¡
```

**3. LastIndex/LastTerm - ãƒªãƒ¼ãƒ€ãƒ¼é¸æŒ™**
```
Candidate: ã€Œç§ã«æŠ•ç¥¨ã—ã¦ï¼LastIndex=10, LastTerm=3ã€
    â†“
Follower: ã€Œç§ã¯ LastIndex=8... å›ã®æ–¹ãŒæ–°ã—ã„ã€OKã€
```

**4. SetCommitIndex - ã‚³ãƒŸãƒƒãƒˆç¢ºå®š**
```
Leader: ã‚¨ãƒ³ãƒˆãƒªã‚’ Follower 2å°ã«é€ä¿¡
    â†“
éåŠæ•°ã‹ã‚‰ OK â†’ SetCommitIndex(7)
    â†“
Client ã«ã€ŒæˆåŠŸã€ã‚’è¿”ã™
```

**5. Truncate - ãƒ­ã‚°ç«¶åˆè§£æ±º**
```
Follower: [1, 2, 3, 4(Term=2), 5(Term=2)]
Leader:   [1, 2, 3, 4(Term=3), 5(Term=3)]
    â†“
Follower: Truncate(3) ã§ 4ä»¥é™ã‚’å‰Šé™¤
    â†“
Leader ã‹ã‚‰ 4, 5 ã‚’å—ä¿¡ã—ã¦ä¸€è‡´
```

---

### Step 3: ãƒªãƒ¼ãƒ€ãƒ¼é¸æŒ™ï¼ˆelection.goï¼‰âœ“

ãƒªãƒ¼ãƒ€ãƒ¼é¸æŒ™ã‚’è¡Œã† RequestVote RPC ã‚’å®Ÿè£…ã€‚

```go
type RequestVoteRequest struct {
    Term         uint64 // å€™è£œè€…ã®ä»»æœŸ
    CandidateID  string // å€™è£œè€…ã®ID
    LastLogIndex uint64 // å€™è£œè€…ã®æœ€å¾Œã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    LastLogTerm  uint64 // å€™è£œè€…ã®æœ€å¾Œã®ãƒ­ã‚°ä»»æœŸ
}

type RequestVoteResponse struct {
    Term        uint64 // ç¾åœ¨ã®ä»»æœŸ
    VoteGranted bool   // æŠ•ç¥¨ãŒè¨±å¯ã•ã‚ŒãŸã‹ã©ã†ã‹
}
```

#### å„é–¢æ•°ã®å½¹å‰²

| é–¢æ•° | å½¹å‰² | ä½¿ç”¨è€… |
|------|------|--------|
| `RequestVote` | æŠ•ç¥¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç† | Follower/Candidate |
| `StartElection` | é¸æŒ™ã‚’é–‹å§‹ | Candidate |
| `HandleVoteResponse` | æŠ•ç¥¨çµæœã‚’å‡¦ç† | Candidate |

#### é¸æŒ™ãŒå§‹ã¾ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°

```text
æ­£å¸¸æ™‚:
  Leader â”€â”€â™¥â”€â”€â™¥â”€â”€â™¥â”€â”€â–¶ Followerï¼ˆãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆå—ä¿¡ï¼‰

ç•°å¸¸æ™‚:
  Leader â”€â”€â™¥â”€â”€â™¥â”€â”€ğŸ’€ï¼ˆã‚¯ãƒ©ãƒƒã‚·ãƒ¥ï¼‰
  Follower: ã€Œãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆãŒæ¥ãªã„...ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ã€
      â†“
  Follower â†’ Candidate ã«é·ç§» â†’ é¸æŒ™é–‹å§‹
```

#### RequestVote ã®æŠ•ç¥¨åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

```text
1. å€™è£œè€…ã®ä»»æœŸãŒå¤ã„ â†’ æ‹’å¦
2. å€™è£œè€…ã®ä»»æœŸãŒæ–°ã—ã„ â†’ è‡ªåˆ†ã®ä»»æœŸã‚’æ›´æ–°ã€votedFor ãƒªã‚»ãƒƒãƒˆ
3. ä»¥ä¸‹ã®æ¡ä»¶ã‚’ã™ã¹ã¦æº€ãŸã™å ´åˆã«æŠ•ç¥¨è¨±å¯:
   - votedFor ãŒç©ºã€ã¾ãŸã¯åŒã˜å€™è£œè€…
   - å€™è£œè€…ã®ãƒ­ã‚°ãŒè‡ªåˆ†ä»¥ä¸Šã«æ–°ã—ã„
     - LastLogTerm ãŒå¤§ãã„ã€ã¾ãŸã¯
     - LastLogTerm ãŒåŒã˜ã§ LastLogIndex ãŒè‡ªåˆ†ä»¥ä¸Š
```

#### ãªãœã€Œãƒ­ã‚°ãŒæ–°ã—ã„ã€å€™è£œè€…ã‚’é¸ã¶ã®ã‹ï¼Ÿ

ãƒ‡ãƒ¼ã‚¿æå¤±ã‚’æœ€å°åŒ–ã™ã‚‹ãŸã‚ã€‚

```text
æ—§Leader: [1, 2, 3, 4, 5] â† ã‚¯ãƒ©ãƒƒã‚·ãƒ¥å‰ã«5ã¾ã§æŒã£ã¦ã„ãŸ
Node A:   [1, 2, 3, 4, 5] â† å…¨éƒ¨å—ä¿¡æ¸ˆã¿
Node B:   [1, 2, 3]       â† é€”ä¸­ã¾ã§

â†’ Node A ãŒæ–°ãƒªãƒ¼ãƒ€ãƒ¼ã«ãªã‚‹ã¹ãï¼ˆãƒ‡ãƒ¼ã‚¿æå¤±ãªã—ï¼‰
```

#### StartElection ã®ãƒ•ãƒ­ãƒ¼

```text
Follower: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç™ºç”Ÿï¼
    â†“
StartElection() å‘¼ã³å‡ºã—
    â†“
1. currentTerm++  (ä»»æœŸã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ)
2. state = Candidate  (å€™è£œè€…ã«ãªã‚‹)
3. votedFor = è‡ªåˆ†  (è‡ªåˆ†ã«æŠ•ç¥¨)
4. RequestVoteRequest ã‚’è¿”ã™
    â†“
ä»–ã®ãƒãƒ¼ãƒ‰ã« RequestVote RPC ã‚’é€ä¿¡
```

#### HandleVoteResponse ã®ãƒ•ãƒ­ãƒ¼

```text
Candidate: RequestVote ã‚’é€ä¿¡
    â†“
å„ãƒãƒ¼ãƒ‰ã‹ã‚‰ Response ã‚’å—ä¿¡
    â†“
HandleVoteResponse() ã§å‡¦ç†:
- ç›¸æ‰‹ã® Term ãŒå¤§ãã„ â†’ Follower ã«æˆ»ã‚‹
- åŒã˜ Term â†’ VoteGranted ã‚’ç¢ºèªï¼ˆå‘¼ã³å‡ºã—å…ƒã§éåŠæ•°ãƒã‚§ãƒƒã‚¯ï¼‰
```

---

### Step 4: ãƒ­ã‚°è¤‡è£½ï¼ˆreplication.goï¼‰âœ“

Leader ã‹ã‚‰ Follower ã¸ã®ãƒ­ã‚°è¤‡è£½ã‚’è¡Œã† AppendEntries RPC ã‚’å®Ÿè£…ã€‚

```go
type AppendEntriesRequest struct {
    Term         uint64     // Leader ã®ä»»æœŸ
    LeaderID     string     // Leader ã®ID
    PrevLogIndex uint64     // ç›´å‰ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    PrevLogTerm  uint64     // ç›´å‰ã®ãƒ­ã‚°ä»»æœŸ
    Entries      []LogEntry // è¤‡è£½ã™ã‚‹ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª
    LeaderCommit uint64     // Leader ã®ã‚³ãƒŸãƒƒãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
}

type AppendEntriesResponse struct {
    Term    uint64 // Follower ã®ä»»æœŸ
    Success bool   // ãƒ­ã‚°è¿½åŠ ãŒæˆåŠŸã—ãŸã‹
}
```

#### ãªãœ AppendEntries ãŒå¿…è¦ã‹ï¼Ÿ

```text
å•é¡Œ: Leader ã ã‘ãŒãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ã‚‹ã¨...

  Leader: [1, 2, 3, 4, 5] â”€â”€ğŸ’€ ã‚¯ãƒ©ãƒƒã‚·ãƒ¥
  Follower 1: []  â† ãƒ‡ãƒ¼ã‚¿ãªã—
  Follower 2: []  â† ãƒ‡ãƒ¼ã‚¿ãªã—
  â†’ ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ï¼

è§£æ±º: AppendEntries ã§å¸¸ã«è¤‡è£½

  Leader: [1, 2, 3, 4, 5]
      â”‚
      â”œâ”€â”€ AppendEntries â”€â”€â–¶ Follower 1: [1, 2, 3, 4, 5]
      â””â”€â”€ AppendEntries â”€â”€â–¶ Follower 2: [1, 2, 3, 4, 5]

  Leader ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¦ã‚‚ Follower ãŒãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ã‚‹
```

#### å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å½¹å‰²

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | ãªãœå¿…è¦ã‹ |
|-----------|-----------|
| `Term` | å¤ã„ Leader ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã™ã‚‹ãŸã‚ |
| `LeaderID` | Follower ãŒèª°ãŒ Leader ã‹çŸ¥ã‚‹ãŸã‚ |
| `PrevLogIndex/Term` | ãƒ­ã‚°ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå¾Œè¿°ï¼‰ |
| `Entries` | è¤‡è£½ã™ã‚‹ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã€‚ç©ºãªã‚‰ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ |
| `LeaderCommit` | Follower ã®ã‚³ãƒŸãƒƒãƒˆä½ç½®ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ |

#### ãªãœ PrevLogIndex / PrevLogTerm ãŒå¿…è¦ã‹ï¼Ÿ

ãƒ­ã‚°ã®æ•´åˆæ€§ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã€‚

```text
å•é¡Œ: Follower ã®ãƒ­ã‚°ãŒ Leader ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„

  Leader:   [1, 2, 3, 4, 5]  â† 4, 5 ã‚’é€ã‚ŠãŸã„
  Follower: [1, 2, X, X, X]  â† 3 ä»¥é™ãŒå£Šã‚Œã¦ã„ã‚‹ã‹ã‚‚ï¼Ÿ

è§£æ±º: PrevLogIndex/PrevLogTerm ã§ç¢ºèª

  Leader: ã€Œ4, 5 ã‚’é€ã‚‹ã€‚ç›´å‰ã® 3 ã¯ Term=2 ã ã‚ˆã­ï¼Ÿã€
      â”‚
      â”‚  PrevLogIndex = 3
      â”‚  PrevLogTerm = 2
      â”‚  Entries = [4, 5]
      â–¼
  Follower: ã€Œ3ç•ªç›®ã‚’ç¢ºèª... Term=2 ã§åˆã£ã¦ã‚‹ï¼ã€
      â†’ Success = true
      â†’ [4, 5] ã‚’è¿½åŠ 

  ã‚‚ã—ä¸€è‡´ã—ãªã‘ã‚Œã°:
  Follower: ã€Œ3ç•ªç›®ã® Term ãŒé•ã†...ã€
      â†’ Success = false
      â†’ Leader ã¯ PrevLogIndex ã‚’ä¸‹ã’ã¦å†é€
```

#### AppendEntries ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```text
Follower ãŒ AppendEntries ã‚’å—ä¿¡:

1. request.Term < currentTerm
   â†’ æ‹’å¦ï¼ˆå¤ã„ Leader ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
   â†’ ãªãœï¼Ÿãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã§å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã“ã¨ãŒã‚ã‚‹

2. request.Term >= currentTerm
   â†’ Follower ã«é·ç§»ã€ä»»æœŸæ›´æ–°ã€LeaderID è¨˜éŒ²
   â†’ ãªãœï¼Ÿæ–°ã—ã„ Leader ã‚’èªè­˜ã™ã‚‹ãŸã‚

3. PrevLogIndex/PrevLogTerm ãƒã‚§ãƒƒã‚¯
   â†’ ç›´å‰ã®ã‚¨ãƒ³ãƒˆãƒªãŒä¸€è‡´ã—ãªã‘ã‚Œã°æ‹’å¦
   â†’ ãªãœï¼Ÿãƒ­ã‚°ã®æ•´åˆæ€§ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚

4. ç«¶åˆãƒã‚§ãƒƒã‚¯ & ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
   â†’ æ—¢å­˜ã‚¨ãƒ³ãƒˆãƒªã¨ Term ãŒé•ãˆã° Truncate ã—ã¦è¿½åŠ 
   â†’ ãªãœï¼Ÿãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­æ™‚ã«å¤ã„ãƒ­ã‚°ãŒæ®‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚

5. commitIndex æ›´æ–°
   â†’ min(LeaderCommit, LastIndex) ã‚’ã‚»ãƒƒãƒˆ
   â†’ ãªãœï¼ŸLeader ã®ã‚³ãƒŸãƒƒãƒˆä½ç½®ã«è¿½å¾“ã™ã‚‹ãŸã‚
```

#### ãªãœç«¶åˆãŒç™ºç”Ÿã™ã‚‹ã®ã‹ï¼Ÿ

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­æ™‚ã«å¤ã„ Leader ãŒæ›¸ãè¾¼ã‚“ã ãƒ­ã‚°ãŒæ®‹ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚

```text
ã‚·ãƒŠãƒªã‚ª: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­

æ™‚ç‚¹1: Leader A ãŒ Term=2 ã§ãƒ­ã‚°ã‚’æ›¸ã
  Leader A: [1, 2, 3(T=2)]
  Follower: [1, 2, 3(T=2)]

æ™‚ç‚¹2: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­ã€æ–° Leader B ãŒ Term=3 ã§é¸å‡º
  Leader B: [1, 2, 3(T=3)]  â† åˆ¥ã®ãƒ‡ãƒ¼ã‚¿
  Follower: [1, 2, 3(T=2)]  â† å¤ã„ã¾ã¾

æ™‚ç‚¹3: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§ã€Leader B ãŒ Follower ã« AppendEntries
  Leader B: PrevLogIndex=2, Entries=[3(T=3)]
  Follower: 3ç•ªç›®ã® Term=2 ã¨ Term=3 ãŒç«¶åˆï¼
      â†’ Truncate(2) ã§ 3 ã‚’å‰Šé™¤
      â†’ æ–°ã—ã„ 3(T=3) ã‚’è¿½åŠ 
      â†’ Leader ã¨ä¸€è‡´
```

#### ãªãœ Response ã§ currentTerm ã‚’è¿”ã™ã®ã‹ï¼Ÿ

å¤ã„ Leader ã«è‡ªåˆ†ãŒå¤ã„ã“ã¨ã‚’çŸ¥ã‚‰ã›ã‚‹ãŸã‚ã€‚

```text
ã‚·ãƒŠãƒªã‚ª: å¤ã„ Leader ãŒã¾ã å‹•ã„ã¦ã„ã‚‹

  æ—§Leader (Term=1): AppendEntries ã‚’é€ä¿¡
      â†“
  Follower (Term=3): ã€Œç§ã® Term ã¯ 3 ã ã‚ˆã€
      â†“
  æ—§Leader: ã€Œ3 > 1 ã ã‹ã‚‰è‡ªåˆ†ã¯å¤ã„...Follower ã«æˆ»ã‚ã†ã€
```

---

### Step 5: ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼ˆheartbeat.goï¼‰âœ“

Leader ãŒå®šæœŸçš„ã« Follower ã«é€ã‚‹ç”Ÿå­˜ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚

```go
const (
    HeartbeatInterval  = 100 * time.Millisecond // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡é–“éš”
    ElectionTimeoutMin = 300 * time.Millisecond // é¸æŒ™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæœ€å°
    ElectionTimeoutMax = 500 * time.Millisecond // é¸æŒ™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæœ€å¤§
)
```

#### ãªãœãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆãŒå¿…è¦ã‹ï¼Ÿ

```text
å•é¡Œ: Follower ã¯ Leader ãŒç”Ÿãã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„

  Leader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Follower
         ï¼ˆä½•ã‚‚é€ã‚‰ãªã„ï¼‰

  Follower: ã€ŒLeader ç”Ÿãã¦ã‚‹ï¼Ÿæ­»ã‚“ã§ã‚‹ï¼Ÿåˆ†ã‹ã‚‰ãªã„...ã€

è§£æ±º: å®šæœŸçš„ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ã‚‹

  Leader â”€â”€â™¥â”€â”€â™¥â”€â”€â™¥â”€â”€â™¥â”€â”€â–¶ Follower
          100msé–“éš”

  Follower: ã€Œãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆãŒæ¥ãŸï¼Leader ã¯ç”Ÿãã¦ã„ã‚‹ã€
```

#### ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ = ç©ºã® AppendEntries

```go
func (n *RaftNode) CreateHeartbeat(log *RaftLog) *AppendEntriesRequest {
    return &AppendEntriesRequest{
        Term:         n.currentTerm,
        LeaderID:     n.nodeID,
        PrevLogIndex: log.LastIndex(),
        PrevLogTerm:  log.LastTerm(),
        Entries:      nil,  // â† ç©ºãŒãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã®ç‰¹å¾´
        LeaderCommit: log.GetCommitIndex(),
    }
}
```

#### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®é–¢ä¿‚

```text
HeartbeatInterval (100ms) < ElectionTimeoutMin (300ms)

ãªãœï¼Ÿ
  - ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã¯ 100ms ã”ã¨ã«é€ä¿¡
  - Follower ã¯ 300ã€œ500ms ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆãŒæ¥ãªã‘ã‚Œã°é¸æŒ™é–‹å§‹
  - ä½™è£•ã‚’æŒãŸã›ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ãŒã‚ã£ã¦ã‚‚é¸æŒ™ãŒèµ·ããªã„
```

#### ãªãœé¸æŒ™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã‹ï¼Ÿ

```text
å›ºå®šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å•é¡Œ:

  Leader ğŸ’€
  Node A: 300ms ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ é¸æŒ™é–‹å§‹
  Node B: 300ms ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ é¸æŒ™é–‹å§‹
  Node C: 300ms ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ é¸æŒ™é–‹å§‹
  â†’ å…¨å“¡ãŒåŒæ™‚ã«ç«‹å€™è£œ â†’ ç¥¨ãŒå‰²ã‚Œã‚‹ â†’ èª°ã‚‚éåŠæ•°å–ã‚Œãªã„

ãƒ©ãƒ³ãƒ€ãƒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®è§£æ±º:

  Leader ğŸ’€
  Node A: 320ms ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ é¸æŒ™é–‹å§‹
  Node B: 450ms ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ã¾ã å¾…æ©Ÿä¸­ â†’ Node A ã«æŠ•ç¥¨
  Node C: 380ms ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ã¾ã å¾…æ©Ÿä¸­ â†’ Node A ã«æŠ•ç¥¨
  â†’ Node A ãŒéåŠæ•°ç²å¾— â†’ Leader ã«
```

#### HandleAppendEntriesResponse ã®å½¹å‰²

```text
Leader ãŒ AppendEntriesï¼ˆã¾ãŸã¯ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼‰ã‚’é€ä¿¡
    â†“
Follower ã‹ã‚‰ Response ã‚’å—ä¿¡
    â†“
HandleAppendEntriesResponse ã§å‡¦ç†:
  - response.Term > currentTerm â†’ è‡ªåˆ†ã¯å¤ã„ã€Follower ã«æˆ»ã‚‹
  - response.Term <= currentTerm â†’ ä½•ã‚‚ã—ãªã„ï¼ˆLeader ç¶™ç¶šï¼‰
```

---

### Step 6: ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆmanager.goï¼‰âœ“

ã“ã‚Œã¾ã§å®Ÿè£…ã—ãŸ Raft ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ±åˆã—ã€è¤‡æ•°ãƒãƒ¼ãƒ‰ã®å”èª¿å‹•ä½œã‚’ç®¡ç†ã™ã‚‹ã€‚

```go
type ReplicationManager struct {
    node *raft.RaftNode  // çŠ¶æ…‹ç®¡ç†
    log  *raft.RaftLog   // ãƒ­ã‚°ç®¡ç†

    peers     []string   // ä»–ãƒãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
    transport Transport  // é€šä¿¡å±¤

    electionTimer  *time.Timer   // é¸æŒ™ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    heartbeatTimer *time.Ticker  // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡é–“éš”
}
```

#### ãªãœ Manager ãŒå¿…è¦ã‹ï¼Ÿ

```text
å•é¡Œ: å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç‹¬ç«‹ã—ã¦ã„ã‚‹

  RaftNode: çŠ¶æ…‹ç®¡ç†ã ã‘
  RaftLog: ãƒ­ã‚°ç®¡ç†ã ã‘
  â†’ èª°ãŒã‚¿ã‚¤ãƒãƒ¼ã‚’ç›£è¦–ã™ã‚‹ï¼Ÿ
  â†’ èª°ãŒ RPC ã‚’é€ä¿¡ã™ã‚‹ï¼Ÿ

è§£æ±º: Manager ãŒçµ±åˆ

  ReplicationManager
    â”œâ”€â”€ RaftNode ã‚’ä¿æŒ
    â”œâ”€â”€ RaftLog ã‚’ä¿æŒ
    â”œâ”€â”€ ã‚¿ã‚¤ãƒãƒ¼ã‚’ç›£è¦–ï¼ˆã‚´ãƒ«ãƒ¼ãƒãƒ³ï¼‰
    â””â”€â”€ Transport ã§ RPC é€ä¿¡
```

#### ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã®å‡¦ç†

```text
Start() ãŒå‘¼ã°ã‚Œã‚‹
    â†“
run() ã‚´ãƒ«ãƒ¼ãƒãƒ³ãŒèµ·å‹•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  for {                                   â”‚
â”‚    select {                              â”‚
â”‚    case <-electionTimer.C:               â”‚
â”‚      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ é¸æŒ™é–‹å§‹          â”‚
â”‚      startElection()                     â”‚
â”‚                                          â”‚
â”‚    case <-heartbeatTimer.C:              â”‚
â”‚      // Leader ãªã‚‰ â†’ ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡   â”‚
â”‚      if state == Leader {                â”‚
â”‚        sendHeartbeats()                  â”‚
â”‚      }                                   â”‚
â”‚                                          â”‚
â”‚    case <-stopCh:                        â”‚
â”‚      return                              â”‚
â”‚    }                                     â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å„é–¢æ•°ã®å½¹å‰²

| é–¢æ•° | å½¹å‰² |
|------|------|
| `Start` | ã‚´ãƒ«ãƒ¼ãƒãƒ³ã§ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ |
| `Stop` | ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ã€ã‚´ãƒ«ãƒ¼ãƒãƒ³çµ‚äº† |
| `resetElectionTimer` | ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š |
| `startElection` | é¸æŒ™ã‚’é–‹å§‹ã—ã€éåŠæ•°ç²å¾—ã§ Leader ã« |
| `sendHeartbeats` | å…¨ãƒãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚’é€ä¿¡ |
| `HandleAppendEntries` | ä»–ãƒãƒ¼ãƒ‰ã‹ã‚‰ã® AppendEntries ã‚’å‡¦ç† |
| `HandleRequestVote` | ä»–ãƒãƒ¼ãƒ‰ã‹ã‚‰ã® RequestVote ã‚’å‡¦ç† |

#### Transport ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```go
type Transport interface {
    SendAppendEntries(peer string, req *AppendEntriesRequest) *AppendEntriesResponse
    SendRequestVote(peer string, req *RequestVoteRequest) *RequestVoteResponse
}
```

å®Ÿéš›ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã¯å°†æ¥å®Ÿè£…ã€‚ç¾åœ¨ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ã¿å®šç¾©ã€‚

---

## Phase 6 å®Œäº†

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|---------|------|
| `internal/raft/state.go` | ãƒãƒ¼ãƒ‰çŠ¶æ…‹ï¼ˆLeader/Follower/Candidateï¼‰ |
| `internal/raft/log.go` | Raft ãƒ­ã‚°ç®¡ç† |
| `internal/raft/election.go` | ãƒªãƒ¼ãƒ€ãƒ¼é¸æŒ™ï¼ˆRequestVoteï¼‰ |
| `internal/raft/replication.go` | ãƒ­ã‚°è¤‡è£½ï¼ˆAppendEntriesï¼‰ |
| `internal/raft/heartbeat.go` | ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ |
| `internal/replication/manager.go` | ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç† |

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Transport å®Ÿè£…** - gRPC ã¾ãŸã¯ HTTP ã§ãƒãƒ¼ãƒ‰é–“é€šä¿¡
2. **æ°¸ç¶šåŒ–** - currentTerm, votedFor, log ã‚’ WAL ã«ä¿å­˜
3. **ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ** - ãƒ­ã‚°åœ§ç¸®
4. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‡¦ç†** - Leader çµŒç”±ã§ã®æ›¸ãè¾¼ã¿

---

## å‚è€ƒè³‡æ–™

- [Raft è«–æ–‡](https://raft.github.io/raft.pdf)
- [Raft Visualization](https://raft.github.io/)
- [etcd/raft](https://github.com/etcd-io/raft) - Go ã® Raft å®Ÿè£…
- [TiKV](https://github.com/tikv/tikv) - TiDB ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¨ãƒ³ã‚¸ãƒ³
