# Phase 7: åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…ãƒ¬ãƒãƒ¼ãƒˆ

## æ¦‚è¦

Phase 7 ã§ã¯ã€åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã®åŸºç›¤ã‚’å®Ÿè£…ã™ã‚‹ã€‚è¤‡æ•°ãƒãƒ¼ãƒ‰ã«ã¾ãŸãŒã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒACIDä¿è¨¼ã•ã‚Œã‚‹ã“ã¨ã‚’ç›®æŒ‡ã™ã€‚

## å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

| Step | å†…å®¹ | çŠ¶æ…‹ |
|------|------|------|
| Step 1 | HLCï¼ˆHybrid Logical Clockï¼‰ | âœ… å®Œäº† |
| Step 2 | MVCCï¼ˆMulti-Version Concurrency Controlï¼‰ | âœ… å®Œäº† |
| Step 3 | 2PCï¼ˆTwo-Phase Commitï¼‰ | âœ… å®Œäº† |
| Step 4 | çµ±åˆãƒ†ã‚¹ãƒˆ | âœ… å®Œäº† |

---

## Step 1: HLCï¼ˆHybrid Logical Clockï¼‰

### ãªãœ HLC ãŒå¿…è¦ã‹ï¼Ÿ

åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€å„ãƒãƒ¼ãƒ‰ã®ç‰©ç†æ™‚è¨ˆãŒãšã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚å˜ç´”ãªç‰©ç†æ™‚è¨ˆã ã‘ã§ã¯ï¼š

1. **æ™‚è¨ˆã®ãšã‚Œ**: ãƒãƒ¼ãƒ‰AãŒ10:00ã€ãƒãƒ¼ãƒ‰BãŒ10:05 ã‚’ç¤ºã—ã¦ã„ã‚‹å ´åˆã€ã©ã¡ã‚‰ãŒã€Œå…ˆã€ã‹åˆ¤æ–­ã§ããªã„
2. **æ™‚è¨ˆã®å·»ãæˆ»ã‚Š**: NTPåŒæœŸã§æ™‚è¨ˆãŒæˆ»ã‚‹ã¨ã€æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãŒå¤ã„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŒã¤å¯èƒ½æ€§

HLC ã¯ä»¥ä¸‹ã‚’çµ„ã¿åˆã‚ã›ã¦è§£æ±ºã™ã‚‹ï¼š
- **ç‰©ç†æ™‚è¨ˆï¼ˆPhysical Clockï¼‰**: Wall Clock ã®ç²¾åº¦ã‚’æ´»ã‹ã™
- **è«–ç†æ™‚è¨ˆï¼ˆLogical Clockï¼‰**: Lamport Clock ã§å› æœé–¢ä¿‚ã‚’ä¿è¨¼

### HLC ã®ä»•çµ„ã¿

```
Timestamp = (Physical, Logical)

æ¯”è¼ƒãƒ«ãƒ¼ãƒ«:
1. Physical ãŒå¤§ãã„æ–¹ãŒã€Œæ–°ã—ã„ã€
2. Physical ãŒåŒã˜ãªã‚‰ Logical ãŒå¤§ãã„æ–¹ãŒã€Œæ–°ã—ã„ã€
```

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- `internal/distributed/hlc.go`
- `internal/distributed/hlc_test.go`

### æ§‹é€ ä½“

```go
// Timestamp - åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ä½¿ã†ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
type Timestamp struct {
    Physical int64  // ç‰©ç†æ™‚é–“ï¼ˆãƒŠãƒç§’ï¼‰
    Logical  uint32 // è«–ç†ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆåŒä¸€ç‰©ç†æ™‚é–“å†…ã§ã®é †åºä»˜ã‘ï¼‰
}

// HybridLogicalClock - HLC æœ¬ä½“
type HybridLogicalClock struct {
    mu             sync.Mutex
    physicalTime   int64  // æœ€å¾Œã«è¦³æ¸¬ã—ãŸæœ€å¤§ã®ç‰©ç†æ™‚é–“
    logicalCounter uint32 // è«–ç†ã‚«ã‚¦ãƒ³ã‚¿
}
```

### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

#### Now() - ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—

```go
func (h *HybridLogicalClock) Now() Timestamp
```

**ãƒ­ã‚¸ãƒƒã‚¯**:
1. ç¾åœ¨ã®ç‰©ç†æ™‚è¨ˆã‚’å–å¾—
2. ç‰©ç†æ™‚è¨ˆãŒé€²ã‚“ã§ã„ãŸã‚‰ â†’ ã‚«ã‚¦ãƒ³ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
3. ç‰©ç†æ™‚è¨ˆãŒé€²ã‚“ã§ã„ãªã‹ã£ãŸã‚‰ â†’ ã‚«ã‚¦ãƒ³ã‚¿ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ

```
Case 1: ç‰©ç†æ™‚è¨ˆãŒé€²ã‚“ã 
  now=100, physicalTime=50
  â†’ physicalTime=100, logicalCounter=0

Case 2: ç‰©ç†æ™‚è¨ˆãŒé€²ã‚“ã§ã„ãªã„ï¼ˆåŒä¸€ãƒŠãƒç§’å†…ï¼‰
  now=100, physicalTime=100
  â†’ physicalTime=100, logicalCounter++
```

#### Update() - ä»–ãƒãƒ¼ãƒ‰ã‹ã‚‰ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å—ä¿¡

```go
func (h *HybridLogicalClock) Update(received Timestamp) Timestamp
```

**ãƒ­ã‚¸ãƒƒã‚¯**:
ä»–ãƒãƒ¼ãƒ‰ã‹ã‚‰å—ä¿¡ã—ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨è‡ªåˆ†ã®æ™‚è¨ˆã‚’æ¯”è¼ƒã—ã€å¸¸ã«ã€Œé€²ã‚€ã€æ–¹å‘ã«æ›´æ–°ã™ã‚‹ã€‚

```
Case 1: ç¾åœ¨æ™‚åˆ»ãŒæœ€å¤§
  now > physicalTime && now > received.Physical
  â†’ physicalTime=now, logicalCounter=0

Case 2: ãƒ­ãƒ¼ã‚«ãƒ«ã®æ–¹ãŒå¤§ãã„
  physicalTime > received.Physical
  â†’ logicalCounter++

Case 3: å—ä¿¡ã—ãŸæ–¹ãŒå¤§ãã„
  received.Physical > physicalTime
  â†’ physicalTime=received.Physical, logicalCounter=received.Logical+1

Case 4: ç‰©ç†æ™‚é–“ãŒåŒã˜
  â†’ logicalCounter = max(logicalCounter, received.Logical) + 1
```

#### Compare() - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®æ¯”è¼ƒ

```go
func (ts *Timestamp) Compare(other Timestamp) int
```

**æˆ»ã‚Šå€¤**:
- `-1`: ts < other
- `0`: ts == other
- `1`: ts > other

### ãƒ†ã‚¹ãƒˆçµæœ

```
=== RUN   TestNewHybridLogicalClock
=== RUN   TestHybridLogicalClock_Now
=== RUN   TestHybridLogicalClock_Now_MonotonicIncrease
=== RUN   TestHybridLogicalClock_Now_LogicalCounterIncrement
=== RUN   TestHybridLogicalClock_Update_ReceivedIsNewer
=== RUN   TestHybridLogicalClock_Update_LocalIsNewer
=== RUN   TestHybridLogicalClock_Update_SamePhysicalTime
=== RUN   TestTimestamp_Compare
=== RUN   TestTimestamp_IsZero
=== RUN   TestTimestamp_String
=== RUN   TestHybridLogicalClock_Concurrent
=== RUN   TestHybridLogicalClock_Update_Concurrent
PASS (13 tests)
```

---

## Step 2: MVCCï¼ˆMulti-Version Concurrency Controlï¼‰

### ãªãœ MVCC ãŒå¿…è¦ã‹ï¼Ÿ

å¾“æ¥ã®ãƒ­ãƒƒã‚¯æ–¹å¼ã®å•é¡Œï¼š

```
Thread A: SELECT * FROM users WHERE id=1  [----èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯----]
Thread B: UPDATE users SET name='Bob'                           [å¾…æ©Ÿ...]

â†’ èª­ã¿å–ã‚ŠãŒæ›¸ãè¾¼ã¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯
â†’ ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆä½ä¸‹
```

MVCC ã®è§£æ±ºç­–ï¼š

```
Thread A: SELECT (ts=50 æ™‚ç‚¹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’èª­ã‚€)
Thread B: UPDATE (ts=100 ã§æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆ)

â†’ èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ãŒç«¶åˆã—ãªã„
â†’ é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ
```

### MVCC ã®ä»•çµ„ã¿

#### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒ¼ãƒ³

```
Key: "user:1"

versions â†’ [ts=100, "Charlie"] â†’ [ts=50, "Bob"] â†’ [ts=10, "Alice"] â†’ nil
            â†‘ æœ€æ–°                                  â†‘ æœ€å¤
```

- æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãã¨ãã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆã•ãšã«æ®‹ã™
- èª­ã¿å–ã‚Šã¯æŒ‡å®šã—ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ™‚ç‚¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿”ã™

#### å¯è¦–æ€§ãƒ«ãƒ¼ãƒ«

```
Get(key, readTs=70):

versions â†’ [ts=100] â†’ [ts=50] â†’ [ts=10] â†’ nil
            â†‘ ã‚¹ã‚­ãƒƒãƒ—   â†‘ è¿”ã™ï¼
            (100 > 70)  (50 <= 70)
```

**åˆ¤å®š**: `version.Timestamp <= readTs` ã®ä¸­ã§æœ€å¤§ã®ã‚‚ã®

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- `internal/distributed/mvcc.go`
- `internal/distributed/mvcc_test.go`

### æ§‹é€ ä½“

```go
// Version - ãƒ‡ãƒ¼ã‚¿ã®1ãƒãƒ¼ã‚¸ãƒ§ãƒ³
type Version struct {
    Timestamp Timestamp // ã„ã¤ä½œã‚‰ã‚ŒãŸã‹
    Data      []byte    // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿
    Deleted   bool      // å‰Šé™¤ãƒãƒ¼ã‚«ãƒ¼ï¼ˆtombstoneï¼‰
    Next      *Version  // 1ã¤å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ãƒã‚¤ãƒ³ã‚¿
}

// MVCCValue - 1ã¤ã®ã‚­ãƒ¼ã«å¯¾ã™ã‚‹å…¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³
type MVCCValue struct {
    mu       sync.RWMutex
    versions *Version // æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆå…ˆé ­ï¼‰
}

// MVCCStore - MVCCå¯¾å¿œã®Key-Valueã‚¹ãƒˆã‚¢
type MVCCStore struct {
    mu    sync.RWMutex
    clock *HybridLogicalClock
    data  map[string]*MVCCValue
}
```

### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

#### Put() - æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿½åŠ 

```go
func (s *MVCCStore) Put(key string, value []byte) Timestamp
```

**ãƒ•ãƒ­ãƒ¼**:
1. HLC ã‹ã‚‰æ–°ã—ã„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—
2. æ–°ã—ã„ Version ã‚’ä½œæˆ
3. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒ¼ãƒ³ã®å…ˆé ­ã«æŒ¿å…¥

```
Before:
versions â†’ [ts=50, "Bob"] â†’ [ts=10, "Alice"] â†’ nil

Put("Charlie") at ts=100:

After:
versions â†’ [ts=100, "Charlie"] â†’ [ts=50, "Bob"] â†’ [ts=10, "Alice"] â†’ nil
```

#### Get() - æŒ‡å®šã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ™‚ç‚¹ã®å€¤ã‚’å–å¾—

```go
func (s *MVCCStore) Get(key string, readTs Timestamp) ([]byte, bool)
```

**ãƒ•ãƒ­ãƒ¼**:
1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒ¼ãƒ³ã‚’å…ˆé ­ã‹ã‚‰è¾¿ã‚‹
2. `readTs` ä»¥ä¸‹ã§æœ€å¤§ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŒã¤ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿”ã™
3. Deleted ãƒ•ãƒ©ã‚°ãŒ true ãªã‚‰ nil ã‚’è¿”ã™

#### Delete() - å‰Šé™¤ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 

```go
func (s *MVCCStore) Delete(key string) Timestamp
```

**ãƒã‚¤ãƒ³ãƒˆ**: å®Ÿéš›ã«ã¯ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã›ãšã€`Deleted: true` ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆtombstoneï¼‰ã‚’è¿½åŠ ã™ã‚‹ã€‚

```
Before:
versions â†’ [ts=50, "Bob"] â†’ nil

Delete() at ts=100:

After:
versions â†’ [ts=100, DELETED] â†’ [ts=50, "Bob"] â†’ nil

Get(readTs=120): nil, false (å‰Šé™¤æ¸ˆã¿)
Get(readTs=70):  "Bob", true (ts=100ã®å‰Šé™¤ã¯è¦‹ãˆãªã„)
```

### ãƒ­ãƒƒã‚¯æˆ¦ç•¥

#### ãªãœ RWMutex ã‚’ä½¿ã†ã‹ï¼Ÿ

| ãƒ­ãƒƒã‚¯ç¨®é¡ | ç”¨é€” | ç‰¹å¾´ |
|-----------|------|------|
| `Lock()` | æ›¸ãè¾¼ã¿ | æ’ä»–çš„ï¼ˆ1äººã ã‘ï¼‰ |
| `RLock()` | èª­ã¿å–ã‚Š | å…±æœ‰çš„ï¼ˆè¤‡æ•°åŒæ™‚OKï¼‰ |

```
Mutex ã ã‘ã®å ´åˆ:
Thread A: Get [----Lock----]
Thread B: Get              [----Lock----]  â† å¾…ãŸã•ã‚Œã‚‹

RWMutex ã®å ´åˆ:
Thread A: Get [----RLock----]
Thread B: Get [----RLock----]  â† åŒæ™‚OKï¼
```

#### ãªãœ2æ®µéšãƒ­ãƒƒã‚¯ã‹ï¼Ÿ

```go
type MVCCStore struct {
    mu   sync.RWMutex              // 1æ®µç›®: map å…¨ä½“
    data map[string]*MVCCValue
}

type MVCCValue struct {
    mu       sync.RWMutex          // 2æ®µç›®: å„ã‚­ãƒ¼
    versions *Version
}
```

**ç†ç”±**: ãƒ­ãƒƒã‚¯ã®ç²’åº¦ã‚’ç´°ã‹ãã—ã¦ä¸¦åˆ—æ€§ã‚’ä¸Šã’ã‚‹

```
1æ®µç›®ã ã‘:
Put("user:1") [----Lock on Store----]
Put("user:2")                        [----Lock----]  â† å¾…ã¤

2æ®µéšãƒ­ãƒƒã‚¯:
Put("user:1") [Lock Store][Lock user:1----]
Put("user:2") [Lock Store][Lock user:2----]  â† åˆ¥ã‚­ãƒ¼ãªã®ã§ä¸¦åˆ—OK
```

#### ãƒ­ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼å›³

**Put ã®å ´åˆ**:
```
1. s.mu.Lock()           Storeå…¨ä½“ã‚’ãƒ­ãƒƒã‚¯
2. data[key] ã‚’å–å¾—
3. mvccValue.mu.Lock()   ã“ã®ã‚­ãƒ¼ã ã‘ãƒ­ãƒƒã‚¯
4. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒ¼ãƒ³ã‚’æ›´æ–°
5. mvccValue.mu.Unlock()
6. s.mu.Unlock()
```

**Get ã®å ´åˆ**:
```
1. s.mu.RLock()          Store ã‚’èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯
2. data[key] ã‚’å–å¾—
3. s.mu.RUnlock()        ã™ãè§£æ”¾
4. mvccValue.mu.RLock()  ã“ã®ã‚­ãƒ¼ã‚’èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯
5. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒ¼ãƒ³ã‚’è¾¿ã‚‹
6. mvccValue.mu.RUnlock()
```

---

## Step 3: 2PCï¼ˆTwo-Phase Commitï¼‰

### ãªãœ 2PC ãŒå¿…è¦ã‹ï¼Ÿ

åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€è¤‡æ•°ãƒãƒ¼ãƒ‰ã«ã¾ãŸãŒã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã€Œå…¨ã¦æˆåŠŸã€ã¾ãŸã¯ã€Œå…¨ã¦å¤±æ•—ã€ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```
ã‚·ãƒŠãƒªã‚ª: ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã«100å††é€é‡‘

Node A: Aã®æ®‹é«˜ã‚’ -100  â† æˆåŠŸ
Node B: Bã®æ®‹é«˜ã‚’ +100  â† å¤±æ•—ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ï¼‰

çµæœ: 100å††ãŒæ¶ˆå¤±ï¼ğŸ’€
```

2PC ã¯ã€å…¨å‚åŠ è€…ã«äº‹å‰ç¢ºèªï¼ˆPrepareï¼‰ã‚’è¡Œã„ã€å…¨å“¡ãŒ Yes ã®å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã“ã¨ã§ã€ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã€‚

### 2PC ã®ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Coordinator â”‚      â”‚ Participant â”‚      â”‚ Participant â”‚
â”‚             â”‚      â”‚   (Node A)  â”‚      â”‚   (Node B)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚
       â”‚ â”€â”€â”€ Prepare â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
       â”‚ â”€â”€â”€ Prepare â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                    â”‚                    â”‚
       â”‚ â—„â”€â”€ Vote Yes â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚ â—„â”€â”€ Vote Yes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                    â”‚                    â”‚
       â”‚     (å…¨å“¡ Yes?)    â”‚                    â”‚
       â”‚                    â”‚                    â”‚
       â”‚ â”€â”€â”€ Commit â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
       â”‚ â”€â”€â”€ Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                    â”‚                    â”‚
       â”‚ â—„â”€â”€ Ack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚ â—„â”€â”€ Ack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â–¼                    â–¼                    â–¼
```

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- `internal/distributed/two_phase_commit.go`
- `internal/distributed/two_phase_commit_test.go`

### æ§‹é€ ä½“

```go
// TxnState - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
type TxnState int

const (
    TxnPending   TxnState = iota // é–‹å§‹å‰
    TxnPrepared                  // æº–å‚™å®Œäº†
    TxnCommitted                 // ã‚³ãƒŸãƒƒãƒˆå®Œäº†
    TxnAborted                   // ä¸­æ­¢å®Œäº†
)

// Coordinator - 2PC ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚¿ãƒ¼
type Coordinator struct {
    mu           sync.Mutex
    participants []Participant        // å‚åŠ è€…ã®ãƒªã‚¹ãƒˆ
    transactions map[TxnID]*TxnRecord // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®è¨˜éŒ²
    clock        *HybridLogicalClock
}

// Participant - å‚åŠ è€…ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
type Participant interface {
    Prepare(request *PrepareRequest) *PrepareResponse
    Commit(request *CommitRequest) *CommitResponse
    Abort(request *AbortRequest) *AbortResponse
}

// LocalParticipant - ãƒ­ãƒ¼ã‚«ãƒ«å‚åŠ è€…ï¼ˆMVCC ã‚¹ãƒˆã‚¢ã¨é€£æºï¼‰
type LocalParticipant struct {
    mu          sync.Mutex
    nodeID      string
    store       *MVCCStore
    preparedTxn map[TxnID]*PrepareData // Prepare æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
}
```

### ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

#### BeginTransaction() - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹

```go
func (c *Coordinator) BeginTransaction(writes []WriteIntent) TxnID
```

**ãƒ•ãƒ­ãƒ¼**:
1. ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³IDã‚’ç”Ÿæˆï¼ˆUUIDï¼‰
2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²ã‚’ä½œæˆï¼ˆçŠ¶æ…‹: TxnPendingï¼‰

#### Commit() - 2PC ã‚’å®Ÿè¡Œ

```go
func (c *Coordinator) Commit(txnID TxnID, writes []WriteIntent) error
```

**ãƒ•ãƒ­ãƒ¼**:
1. **Phase 1: Prepare** - å…¨å‚åŠ è€…ã« Prepare ã‚’é€ä¿¡
2. 1äººã§ã‚‚ No â†’ å…¨å“¡ã« Abort ã‚’é€ä¿¡ã€ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
3. **Phase 2: Commit** - å…¨å“¡ Yes ãªã‚‰å…¨å‚åŠ è€…ã« Commit ã‚’é€ä¿¡

```go
// Phase 1: Prepare
for _, participant := range c.participants {
    resp := participant.Prepare(&PrepareRequest{...})
    if !resp.Vote {
        allYes = false
        break
    }
}

// Phase 2: Commit or Abort
if allYes {
    for _, participant := range c.participants {
        participant.Commit(&CommitRequest{...})
    }
} else {
    for _, participant := range c.participants {
        participant.Abort(&AbortRequest{...})
    }
}
```

#### LocalParticipant.Prepare() - ã‚³ãƒŸãƒƒãƒˆå¯èƒ½ã‹ç¢ºèª

```go
func (p *LocalParticipant) Prepare(request *PrepareRequest) *PrepareResponse
```

**ãƒ•ãƒ­ãƒ¼**:
1. æ›¸ãè¾¼ã¿äºˆå®šã®ãƒ‡ãƒ¼ã‚¿ã‚’ `preparedTxn` ã«ä¿å­˜
2. Vote: true ã‚’è¿”ã™

#### LocalParticipant.Commit() - å®Ÿéš›ã«ã‚³ãƒŸãƒƒãƒˆ

```go
func (p *LocalParticipant) Commit(request *CommitRequest) *CommitResponse
```

**ãƒ•ãƒ­ãƒ¼**:
1. `preparedTxn` ã‹ã‚‰æ›¸ãè¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
2. MVCC ã‚¹ãƒˆã‚¢ã«æ›¸ãè¾¼ã¿ï¼ˆ`store.Put()`ï¼‰
3. `preparedTxn` ã‹ã‚‰å‰Šé™¤

#### LocalParticipant.Abort() - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```go
func (p *LocalParticipant) Abort(request *AbortRequest) *AbortResponse
```

**ãƒ•ãƒ­ãƒ¼**:
1. `preparedTxn` ã‹ã‚‰å‰Šé™¤ï¼ˆä½•ã‚‚æ›¸ãè¾¼ã¾ãªã„ï¼‰

### ãƒ†ã‚¹ãƒˆçµæœ

```
=== RUN   TestNewCoordinator
=== RUN   TestNewLocalParticipant
=== RUN   TestCoordinator_BeginTransaction
=== RUN   TestCoordinator_Commit_SingleParticipant
=== RUN   TestCoordinator_Commit_MultipleParticipants
=== RUN   TestLocalParticipant_Prepare
=== RUN   TestLocalParticipant_Commit
=== RUN   TestLocalParticipant_Commit_NotPrepared
=== RUN   TestLocalParticipant_Abort
=== RUN   TestCoordinator_Commit_OneVoteNo
=== RUN   TestCoordinator_Commit_AllVoteYes
=== RUN   TestCoordinator_Concurrent
=== RUN   TestTxnState
PASS (15 tests)
```

### 2PC ã®é™ç•Œã¨æ”¹å–„ç‚¹

| å•é¡Œ | èª¬æ˜ | æ”¹å–„ç­– |
|------|------|--------|
| **ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°** | Coordinator ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨å‚åŠ è€…ãŒãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®ã¾ã¾ | 3PCï¼ˆThree-Phase Commitï¼‰ |
| **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·** | 2å¾€å¾©ã®é€šä¿¡ãŒå¿…è¦ | Paxos / Raft ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒŸãƒƒãƒˆ |
| **å˜ä¸€éšœå®³ç‚¹** | Coordinator ãŒå˜ä¸€éšœå®³ç‚¹ | è¤‡æ•° Coordinator |

---

## Step 4: çµ±åˆãƒ†ã‚¹ãƒˆ

### ç›®çš„

HLC + MVCC + 2PC ã‚’çµ„ã¿åˆã‚ã›ãŸåˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã€‚

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

- `internal/distributed/integration_test.go`

### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

| ãƒ†ã‚¹ãƒˆå | ã‚·ãƒŠãƒªã‚ª | ç¢ºèªå†…å®¹ |
|---------|---------|---------|
| `TestIntegration_TransferSuccess` | é€é‡‘æˆåŠŸ | è¤‡æ•°ãƒãƒ¼ãƒ‰ã¸ã®æ›¸ãè¾¼ã¿ãŒæˆåŠŸ |
| `TestIntegration_TransferFailure` | é€é‡‘å¤±æ•— | 1äºº No ã§ã‚¢ãƒœãƒ¼ãƒˆã€ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãªã— |
| `TestIntegration_SnapshotIsolation` | ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåˆ†é›¢ | èª­ã¿å–ã‚Šä¸­ã®æ›¸ãè¾¼ã¿ãŒè¦‹ãˆãªã„ |
| `TestIntegration_SnapshotIsolation_Delete` | å‰Šé™¤ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ | å‰Šé™¤å‰ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ãˆã‚‹ |
| `TestIntegration_ConcurrentTransactions` | ä¸¦è¡Œãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ | 100ä¸¦åˆ—ã§ãƒ‡ãƒ¼ã‚¿ç ´æãªã— |
| `TestIntegration_ConcurrentReadWrite` | ä¸¦è¡Œèª­ã¿æ›¸ã | èª­ã¿æ›¸ãæ··åœ¨ã§ãƒ‡ãƒ¼ã‚¿ç ´æãªã— |
| `TestIntegration_HLC_Causality` | HLC å› æœé–¢ä¿‚ | ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒå˜èª¿å¢—åŠ  |
| `TestIntegration_HLC_Update` | HLC ãƒãƒ¼ãƒ‰é–“åŒæœŸ | å—ä¿¡å¾Œã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒå¤§ãã„ |
| `TestIntegration_MultiNode_Consistency` | 3ãƒãƒ¼ãƒ‰ä¸€è²«æ€§ | å…¨ãƒãƒ¼ãƒ‰ã§åŒã˜å€¤ãŒè¦‹ãˆã‚‹ |
| `TestIntegration_EndToEnd_BankTransfer` | éŠ€è¡ŒæŒ¯è¾¼E2E | æŒ¯è¾¼å‰å¾Œã®æ®‹é«˜ãŒæ­£ã—ã„ |

### éŠ€è¡ŒæŒ¯è¾¼ã‚·ãƒŠãƒªã‚ª

```
åˆæœŸçŠ¶æ…‹:
  Alice: 1000å††
  Bob:   500å††

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³: Alice â†’ Bob ã¸ 200å††æŒ¯è¾¼

çµæœ:
  Alice: 800å†† (1000 - 200)
  Bob:   700å†† (500 + 200)

ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ:
  æŒ¯è¾¼å‰ã®æ™‚ç‚¹ã§èª­ã¿å–ã‚‹ã¨ã€Alice=1000, Bob=500 ãŒè¦‹ãˆã‚‹
```

### ç™ºè¦‹ãƒ»ä¿®æ­£ã—ãŸãƒã‚°

| ç®‡æ‰€ | å•é¡Œ | ä¿®æ­£ |
|------|------|------|
| `Coordinator.Commit` | `c.transactions[txnID]` ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ãƒ­ãƒƒã‚¯ãªã— | `c.mu.Lock()` / `c.mu.Unlock()` ã‚’è¿½åŠ  |

ä¸¦è¡Œãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šã€ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’æ¤œå‡ºãƒ»ä¿®æ­£ã—ãŸã€‚

---

## ç”¨èªé›†

### æ™‚è¨ˆãƒ»ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é–¢é€£

| ç”¨èª | æ„å‘³ | ãªãœå¿…è¦ã‹ |
|------|------|-----------|
| **Physical Clockï¼ˆç‰©ç†æ™‚è¨ˆï¼‰** | ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®å®Ÿéš›ã®æ™‚è¨ˆï¼ˆWall Clockï¼‰ã€‚ãƒŠãƒç§’å˜ä½ã§æ™‚åˆ»ã‚’è¿”ã™ã€‚ | äººé–“ãŒç†è§£ã—ã‚„ã™ã„ã€Œã„ã¤ã€ã‚’è¡¨ç¾ã§ãã‚‹ã€‚ãŸã ã—ã€ãƒãƒ¼ãƒ‰é–“ã§ãšã‚ŒãŒç”Ÿã˜ã‚‹å•é¡ŒãŒã‚ã‚‹ã€‚ |
| **Logical Clockï¼ˆè«–ç†æ™‚è¨ˆï¼‰** | ã‚¤ãƒ™ãƒ³ãƒˆã®å› æœé–¢ä¿‚ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®ã‚«ã‚¦ãƒ³ã‚¿ã€‚Lamport Clock ã¨ã‚‚å‘¼ã°ã‚Œã‚‹ã€‚ | ç‰©ç†æ™‚è¨ˆãŒãšã‚Œã¦ã„ã¦ã‚‚ã€ã€ŒAãŒBã‚ˆã‚Šå‰ã«èµ·ããŸã€ã¨ã„ã†é †åºã‚’ä¿è¨¼ã§ãã‚‹ã€‚ |
| **HLCï¼ˆHybrid Logical Clockï¼‰** | ç‰©ç†æ™‚è¨ˆã¨è«–ç†æ™‚è¨ˆã‚’çµ„ã¿åˆã‚ã›ãŸæ™‚è¨ˆã€‚`(Physical, Logical)` ã®ãƒšã‚¢ã§è¡¨ç¾ã€‚ | ç‰©ç†æ™‚è¨ˆã®ã€Œäººé–“ã«ç†è§£ã—ã‚„ã™ã„ã€åˆ©ç‚¹ã¨ã€è«–ç†æ™‚è¨ˆã®ã€Œé †åºä¿è¨¼ã€åˆ©ç‚¹ã‚’ä¸¡ç«‹ã™ã‚‹ã€‚ |
| **Timestampï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰** | ã‚ã‚‹ç¬é–“ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹å€¤ã€‚HLC ã§ã¯ `(Physical, Logical)` ã®ãƒšã‚¢ã€‚ | ã€Œã“ã®æ›¸ãè¾¼ã¿ã¯ã„ã¤è¡Œã‚ã‚ŒãŸã‹ã€ã€Œã“ã®èª­ã¿å–ã‚Šã¯ã©ã®æ™‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹ã‹ã€ã‚’æ±ºå®šã™ã‚‹ã€‚ |
| **Monotonicï¼ˆå˜èª¿å¢—åŠ ï¼‰** | å€¤ãŒå¸¸ã«å¢—åŠ ã—ã€æ±ºã—ã¦æ¸›å°‘ã—ãªã„æ€§è³ªã€‚ | ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒå·»ãæˆ»ã‚‹ã¨ã€Œæ–°ã—ã„æ›¸ãè¾¼ã¿ãŒå¤ãè¦‹ãˆã‚‹ã€å•é¡ŒãŒèµ·ãã‚‹ã€‚å˜èª¿å¢—åŠ ã‚’ä¿è¨¼ã™ã‚‹ã“ã¨ã§é˜²ãã€‚ |

### MVCC é–¢é€£

| ç”¨èª | æ„å‘³ | ãªãœå¿…è¦ã‹ |
|------|------|-----------|
| **MVCCï¼ˆMulti-Version Concurrency Controlï¼‰** | åŒä¸€ãƒ‡ãƒ¼ã‚¿ã®è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒã—ã€èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’ä¸¦è¡Œå®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹æŠ€è¡“ã€‚ | å¾“æ¥ã®ãƒ­ãƒƒã‚¯æ–¹å¼ã§ã¯èª­ã¿å–ã‚ŠãŒæ›¸ãè¾¼ã¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã€‚MVCC ã§ã¯èª­ã¿å–ã‚ŠãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãšã€é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’å®Ÿç¾ã€‚ |
| **Versionï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰** | ãƒ‡ãƒ¼ã‚¿ã®ç‰¹å®šæ™‚ç‚¹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ãƒ‡ãƒ¼ã‚¿ã€å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚’æŒã¤ã€‚ | åŒä¸€ã‚­ãƒ¼ã®å±¥æ­´ã‚’ä¿æŒã—ã€ä»»æ„ã®æ™‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—å¯èƒ½ã«ã™ã‚‹ã€‚ |
| **Version Chainï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒ¼ãƒ³ï¼‰** | åŒä¸€ã‚­ãƒ¼ã®è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é€£çµãƒªã‚¹ãƒˆã§ç®¡ç†ã™ã‚‹æ§‹é€ ã€‚æœ€æ–°â†’å¤ã„ã®é †ã€‚ | ç‰¹å®šã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ™‚ç‚¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åŠ¹ç‡çš„ã«æ¤œç´¢ã§ãã‚‹ã€‚ |
| **Tombstoneï¼ˆå¢“çŸ³ï¼‰** | å‰Šé™¤ãƒãƒ¼ã‚«ãƒ¼ã€‚`Deleted: true` ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆã•ãªã„ã€‚ | ã€Œã“ã®ã‚­ãƒ¼ã¯ ts=100 ã§å‰Šé™¤ã•ã‚ŒãŸã€ã¨ã„ã†æƒ…å ±ã‚’ä¿æŒã€‚éå»ã®æ™‚ç‚¹ã§ã¯å‰Šé™¤å‰ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ãˆã‚‹ã€‚ |
| **Snapshot Readï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆèª­ã¿å–ã‚Šï¼‰** | ç‰¹å®šã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ™‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹æ“ä½œã€‚ãã®å¾Œã®æ›¸ãè¾¼ã¿ã¯è¦‹ãˆãªã„ã€‚ | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ç‚¹ã®ä¸€è²«ã—ãŸãƒ“ãƒ¥ãƒ¼ã‚’æä¾›ã€‚èª­ã¿å–ã‚Šä¸­ã«ä»–ã®æ›¸ãè¾¼ã¿ãŒã‚ã£ã¦ã‚‚å½±éŸ¿ã•ã‚Œãªã„ã€‚ |
| **Visibilityï¼ˆå¯è¦–æ€§ï¼‰** | ã‚ã‚‹ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§èª­ã¿å–ã£ãŸã¨ãã€ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã€Œè¦‹ãˆã‚‹ã€ã‹ã€‚ | `version.Timestamp <= readTs` ã®ä¸­ã§æœ€å¤§ã®ã‚‚ã®ãŒè¦‹ãˆã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šä¸€è²«æ€§ã‚’ä¿è¨¼ã€‚ |

### ãƒ­ãƒƒã‚¯ãƒ»ä¸¦è¡Œåˆ¶å¾¡é–¢é€£

| ç”¨èª | æ„å‘³ | ãªãœå¿…è¦ã‹ |
|------|------|-----------|
| **Mutexï¼ˆãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ï¼‰** | ç›¸äº’æ’ä»–ãƒ­ãƒƒã‚¯ã€‚ä¸€åº¦ã«1ã¤ã®ã‚´ãƒ«ãƒ¼ãƒãƒ³ã ã‘ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€‚ | è¤‡æ•°ã‚´ãƒ«ãƒ¼ãƒãƒ³ãŒåŒæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ç ´æãŒèµ·ãã‚‹ã€‚ã“ã‚Œã‚’é˜²ãã€‚ |
| **RWMutexï¼ˆèª­ã¿æ›¸ããƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ï¼‰** | èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’åŒºåˆ¥ã™ã‚‹ãƒ­ãƒƒã‚¯ã€‚èª­ã¿å–ã‚ŠåŒå£«ã¯ä¸¦è¡Œå¯èƒ½ã€‚ | èª­ã¿å–ã‚Šã¯å®‰å…¨ã«ä¸¦è¡Œå®Ÿè¡Œã§ãã‚‹ã€‚å…¨ã¦ã‚’æ’ä»–ãƒ­ãƒƒã‚¯ã™ã‚‹ã¨ç„¡é§„ã«é…ããªã‚‹ã€‚ |
| **Lock() / Unlock()** | æ›¸ãè¾¼ã¿ãƒ­ãƒƒã‚¯ã€‚æ’ä»–çš„ã§ã€1ã¤ã®ã‚´ãƒ«ãƒ¼ãƒãƒ³ã ã‘ãŒä¿æŒå¯èƒ½ã€‚ | ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹éš›ã€ä»–ã®èª­ã¿å–ã‚Šãƒ»æ›¸ãè¾¼ã¿ã‚’å…¨ã¦ãƒ–ãƒ­ãƒƒã‚¯ã€‚ |
| **RLock() / RUnlock()** | èª­ã¿å–ã‚Šãƒ­ãƒƒã‚¯ã€‚å…±æœ‰çš„ã§ã€è¤‡æ•°ã®ã‚´ãƒ«ãƒ¼ãƒãƒ³ãŒåŒæ™‚ã«ä¿æŒå¯èƒ½ã€‚ | èª­ã¿å–ã‚ŠåŒå£«ã¯ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ãªã„ã®ã§ä¸¦è¡Œã—ã¦ã‚‚å®‰å…¨ã€‚ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Šã€‚ |
| **Lock Granularityï¼ˆãƒ­ãƒƒã‚¯ç²’åº¦ï¼‰** | ãƒ­ãƒƒã‚¯ã®å¯¾è±¡ç¯„å›²ã€‚ç²—ã„ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ï¼‰ã€œç´°ã‹ã„ï¼ˆè¡Œå˜ä½ï¼‰ã€‚ | ç²—ã„ã¨å®Ÿè£…ãŒç°¡å˜ã ãŒä¸¦åˆ—æ€§ãŒä½ã„ã€‚ç´°ã‹ã„ã¨ä¸¦åˆ—æ€§ã¯é«˜ã„ãŒã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒã‚ã‚‹ã€‚ |
| **Deadlockï¼ˆãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ï¼‰** | è¤‡æ•°ã®ã‚´ãƒ«ãƒ¼ãƒãƒ³ãŒäº’ã„ã®ãƒ­ãƒƒã‚¯è§£æ”¾ã‚’å¾…ã¡ã€æ°¸ä¹…ã«é€²ã¾ãªã„çŠ¶æ…‹ã€‚ | ãƒ­ãƒƒã‚¯ã®é †åºã‚’çµ±ä¸€ã™ã‚‹ã“ã¨ã§é˜²ãã€‚2æ®µéšãƒ­ãƒƒã‚¯ã§ã¯ Store â†’ Value ã®é †ã§å–å¾—ã€‚ |

### åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ é–¢é€£

| ç”¨èª | æ„å‘³ | ãªãœå¿…è¦ã‹ |
|------|------|-----------|
| **Nodeï¼ˆãƒãƒ¼ãƒ‰ï¼‰** | åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹æˆã™ã‚‹1å°ã®ã‚µãƒ¼ãƒãƒ¼ã€‚ | å˜ä¸€ãƒãƒ¼ãƒ‰ã§ã¯å‡¦ç†èƒ½åŠ›ãƒ»ãƒ‡ãƒ¼ã‚¿é‡ã«é™ç•ŒãŒã‚ã‚‹ã€‚è¤‡æ•°ãƒãƒ¼ãƒ‰ã§åˆ†æ•£å‡¦ç†ã€‚ |
| **Clock Skewï¼ˆæ™‚è¨ˆã®ãšã‚Œï¼‰** | ãƒãƒ¼ãƒ‰é–“ã®ç‰©ç†æ™‚è¨ˆã®ãšã‚Œã€‚NTP ã§åŒæœŸã—ã¦ã‚‚æ•°msã€œæ•°åmsã®ãšã‚ŒãŒæ®‹ã‚‹ã€‚ | æ™‚è¨ˆãŒãšã‚Œã¦ã„ã‚‹ã¨ã€Œã©ã¡ã‚‰ãŒå…ˆã‹ã€ã®åˆ¤æ–­ãŒé›£ã—ã„ã€‚HLC ã¯ã“ã‚Œã‚’è§£æ±ºã€‚ |
| **NTPï¼ˆNetwork Time Protocolï¼‰** | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¶Šã—ã«æ™‚è¨ˆã‚’åŒæœŸã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‚ | å„ãƒãƒ¼ãƒ‰ã®æ™‚è¨ˆã‚’æƒãˆã‚‹ãŸã‚ã«ä½¿ã†ãŒã€å®Œå…¨ã«ã¯åŒæœŸã§ããªã„ã€‚ |
| **Causalityï¼ˆå› æœé–¢ä¿‚ï¼‰** | ã€Œã‚¤ãƒ™ãƒ³ãƒˆAãŒã‚¤ãƒ™ãƒ³ãƒˆBã®åŸå› ã§ã‚ã‚‹ã€ã¨ã„ã†é–¢ä¿‚ã€‚A â†’ Bã€‚ | å› æœé–¢ä¿‚ãŒã‚ã‚‹æ“ä½œã¯æ­£ã—ã„é †åºã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ä¾‹ï¼šæ›¸ãè¾¼ã¿â†’èª­ã¿å–ã‚Šã€‚ |
| **Consistencyï¼ˆä¸€è²«æ€§ï¼‰** | ãƒ‡ãƒ¼ã‚¿ãŒçŸ›ç›¾ãªãæ­£ã—ã„çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã€‚ | è¤‡æ•°ãƒãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤å ´åˆã€å…¨ãƒãƒ¼ãƒ‰ã§åŒã˜å€¤ãŒè¦‹ãˆã‚‹ã“ã¨ãŒé‡è¦ã€‚ |

### 2PC é–¢é€£

| ç”¨èª | æ„å‘³ | ãªãœå¿…è¦ã‹ |
|------|------|-----------|
| **2PCï¼ˆTwo-Phase Commitï¼‰** | åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¢ãƒˆãƒŸãƒƒã‚¯ã«ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã€‚Prepare ã¨ Commit ã®2æ®µéšã€‚ | è¤‡æ•°ãƒãƒ¼ãƒ‰ã«ã¾ãŸãŒã‚‹æ“ä½œã‚’ã€Œå…¨ã¦æˆåŠŸã€orã€Œå…¨ã¦å¤±æ•—ã€ã«ã™ã‚‹ã€‚ä¸­é€”åŠç«¯ãªçŠ¶æ…‹ã‚’é˜²ãã€‚ |
| **Coordinatorï¼ˆã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚¿ãƒ¼ï¼‰** | 2PC ã‚’ä¸»å°ã™ã‚‹ãƒãƒ¼ãƒ‰ã€‚å„å‚åŠ è€…ã« Prepare/Commit ã‚’é€ã‚‹ã€‚ | åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ã€Œã¾ã¨ã‚å½¹ã€ãŒå¿…è¦ã€‚ |
| **Participantï¼ˆå‚åŠ è€…ï¼‰** | 2PC ã«å‚åŠ ã™ã‚‹ãƒãƒ¼ãƒ‰ã€‚Prepare ã«å¯¾ã—ã¦ Yes/No ã‚’è¿”ã™ã€‚ | å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤ãƒãƒ¼ãƒ‰ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚³ãƒŸãƒƒãƒˆå¯èƒ½ã‹ã‚’åˆ¤æ–­ã€‚ |
| **Prepare Phase** | å„å‚åŠ è€…ã«ã€Œã‚³ãƒŸãƒƒãƒˆã§ãã‚‹ã‹ï¼Ÿã€ã‚’å•ã„åˆã‚ã›ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã€‚ | å…¨å“¡ãŒ Yes ãªã‚‰ Commitã€1äººã§ã‚‚ No ãªã‚‰ Abortã€‚äº‹å‰ç¢ºèªã«ã‚ˆã‚Šæ•´åˆæ€§ã‚’ä¿è¨¼ã€‚ |
| **Commit Phase** | å…¨å“¡ãŒ Yes ãªã‚‰å®Ÿéš›ã«ã‚³ãƒŸãƒƒãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã€‚ | Prepare ã§ç¢ºç´„ã—ãŸã®ã§ã€ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã¯å¿…ãšæˆåŠŸã™ã‚‹ï¼ˆã¯ãšï¼‰ã€‚ |
| **Abortï¼ˆã‚¢ãƒœãƒ¼ãƒˆï¼‰** | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸­æ­¢ã—ã€å¤‰æ›´ã‚’å–ã‚Šæ¶ˆã™ã“ã¨ã€‚ | 1äººã§ã‚‚ã‚³ãƒŸãƒƒãƒˆã§ããªã„å ´åˆã€å…¨å“¡ãŒå¤‰æ›´ã‚’å–ã‚Šæ¶ˆã™ã€‚ |

### Go è¨€èªé–¢é€£

| ç”¨èª | æ„å‘³ | ãªãœå¿…è¦ã‹ |
|------|------|-----------|
| **Goroutineï¼ˆã‚´ãƒ«ãƒ¼ãƒãƒ³ï¼‰** | Go ã®è»½é‡ã‚¹ãƒ¬ãƒƒãƒ‰ã€‚`go func()` ã§èµ·å‹•ã€‚ | ä¸¦è¡Œå‡¦ç†ã‚’ç°¡å˜ã«å®Ÿç¾ã€‚1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ = 1ã¤ã®ã‚´ãƒ«ãƒ¼ãƒãƒ³ã€‚ |
| **Channelï¼ˆãƒãƒ£ãƒãƒ«ï¼‰** | ã‚´ãƒ«ãƒ¼ãƒãƒ³é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã™ã‚‹ä»•çµ„ã¿ã€‚ | ã‚´ãƒ«ãƒ¼ãƒãƒ³é–“ã®é€šä¿¡ã¨åŒæœŸã«ä½¿ã†ã€‚ãƒ­ãƒƒã‚¯ã‚ˆã‚Šå®‰å…¨ãªå ´åˆã‚‚ã€‚ |
| **defer** | é–¢æ•°çµ‚äº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’ç™»éŒ²ã€‚`defer mu.Unlock()` ãªã©ã€‚ | ãƒ­ãƒƒã‚¯è§£æ”¾å¿˜ã‚Œã‚’é˜²ãã€‚æ—©æœŸ return ãŒã‚ã£ã¦ã‚‚ç¢ºå®Ÿã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚ |
| **sync.Mutex** | æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ’ä»–ãƒ­ãƒƒã‚¯ã€‚ | æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ­ãƒƒã‚¯ã€‚èª­ã¿æ›¸ãã®åŒºåˆ¥ãŒä¸è¦ãªå ´åˆã«ä½¿ã†ã€‚ |
| **sync.RWMutex** | æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿æ›¸ããƒ­ãƒƒã‚¯ã€‚ | èª­ã¿å–ã‚ŠãŒå¤šã„å ´åˆã«æœ‰åŠ¹ã€‚MVCC ã® Get ã§ä½¿ç”¨ã€‚ |

---

## ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ãƒ†ã‚¹ãƒˆæ•° | çŠ¶æ…‹ |
|---------|---------|------|
| HLC | 13 | âœ… PASS |
| MVCC | 13 | âœ… PASS |
| 2PC | 15 | âœ… PASS |
| çµ±åˆãƒ†ã‚¹ãƒˆ | 10 | âœ… PASS |
| **åˆè¨ˆ** | **51** | **âœ… PASS** |

---

## Phase 7 å®Œäº†

Phase 7: åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ãŒå®Œäº†ã—ãŸã€‚

### é”æˆã—ãŸæ©Ÿèƒ½

1. **HLCï¼ˆHybrid Logical Clockï¼‰** - åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®è«–ç†æ™‚è¨ˆ
2. **MVCCï¼ˆMulti-Version Concurrency Controlï¼‰** - è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
3. **2PCï¼ˆTwo-Phase Commitï¼‰** - åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒˆãƒŸãƒƒã‚¯ã‚³ãƒŸãƒƒãƒˆ
4. **çµ±åˆãƒ†ã‚¹ãƒˆ** - ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®å‹•ä½œç¢ºèª

### æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚º

- **Phase 8: ã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°** - ãƒ¬ãƒ³ã‚¸ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿åˆ†å‰²
- **Phase 9: åˆ†æ•£ã‚¯ã‚¨ãƒªå®Ÿè¡Œ** - è¤‡æ•°ãƒãƒ¼ãƒ‰ã«ã¾ãŸãŒã‚‹ã‚¯ã‚¨ãƒª
- **Phase 10: æœ¬ç•ªé‹ç”¨æ©Ÿèƒ½** - ã‚¯ãƒ©ã‚¹ã‚¿ç®¡ç†ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

---

## å‚è€ƒè³‡æ–™

- [Hybrid Logical Clocks (HLC)](https://cse.buffalo.edu/tech-reports/2014-04.pdf) - HLC è«–æ–‡
- [CockroachDB MVCC](https://www.cockroachlabs.com/docs/stable/architecture/storage-layer.html) - MVCC ã®å®Ÿè£…ä¾‹
- [Percolator](https://research.google/pubs/pub36726/) - Google ã®åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
